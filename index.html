<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Importar Backlog a Trello — CSV → Tarjetas (Tailwind)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark">
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold tracking-tight">Importar Backlog a Trello</h1>
      <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">CSV → Tarjetas. Compatible con Windows/Mac/Linux (CRLF/LF) y archivos con BOM.</p>
    </header>

    <section class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 mb-6 shadow-sm">
      <p>Este asistente crea <span class="font-medium">listas que falten</span> (p. ej. <code>Backlog</code>) y luego tarjetas a partir de un CSV con columnas <code class="bg-slate-100 dark:bg-slate-700 px-1 rounded">Name, Description, Labels, List</code>.</p>
      <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Los errores de telemetría de Atlassian (<code>xp.atlassian.com</code>) son inocuos. El flujo usa exclusivamente <code>api.trello.com</code>.</p>
    </section>

    <section class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 mb-6 shadow-sm">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="apiKey" class="block text-sm font-medium mb-1">API Key de Trello</label>
          <input id="apiKey" type="text" placeholder="p.ej. 6260..." class="w-full rounded-xl border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" />
        </div>
        <div>
          <label for="token" class="block text-sm font-medium mb-1">Token personal</label>
          <input id="token" type="password" placeholder="Tu token de autorización" class="w-full rounded-xl border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" />
        </div>
        <div>
          <label for="csvFile" class="block text-sm font-medium mb-1">CSV</label>
          <input id="csvFile" type="file" accept=".csv,text/csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200 dark:file:bg-slate-700 dark:file:text-slate-100 dark:hover:file:bg-slate-600" />
          <p class="text-xs text-slate-500 mt-1">Asegurate del encabezado: <code>Name,Description,Labels,List</code>.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="boardSelect" class="block text-sm font-medium mb-1">Tablero destino</label>
            <select id="boardSelect" disabled class="w-full rounded-xl border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
              <option value="">Cargar tableros…</option>
            </select>
          </div>
          <div>
            <label for="delay" class="block text-sm font-medium mb-1">Delay por tarjeta (ms)</label>
            <input id="delay" type="number" value="180" class="w-full rounded-xl border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" />
            <p class="text-xs text-slate-500 mt-1">Subí a 250–300 si ves rate limit.</p>
          </div>
        </div>
      </div>

      <div class="mt-5 flex flex-wrap items-center gap-3">
        <button id="btnLoadBoards" class="inline-flex items-center gap-2 rounded-xl bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold px-4 py-2 shadow-sm transition">
          <span>1) Cargar tableros</span>
        </button>
        <button id="btnRun" disabled class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold px-4 py-2 shadow-sm transition disabled:opacity-50 disabled:cursor-not-allowed">
          <span>2) Importar CSV → Trello</span>
        </button>
        <button id="btnSaveLocal" class="ml-auto text-xs text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">Guardar key/token en este navegador</button>
        <button id="btnClearLocal" class="text-xs text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">Borrar key/token</button>
      </div>
    </section>

    <section class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
      <div class="flex items-center justify-between mb-3">
        <div>
          <label for="prog" class="block text-sm font-medium">Estado</label>
          <div id="status" class="text-sm text-slate-500 dark:text-slate-400">Esperando…</div>
        </div>
        <progress id="prog" value="0" max="100" class="w-64 h-3"></progress>
      </div>
      <div>
        <label for="log" class="block text-sm font-medium mb-1">Registro</label>
        <pre id="log" class="bg-slate-900 text-slate-100 rounded-xl p-3 text-xs max-h-72 overflow-auto"></pre>
      </div>
    </section>

    <div id="toast" class="fixed bottom-4 right-4 hidden">
      <div class="bg-slate-900/90 text-white text-sm px-4 py-2 rounded-xl shadow-lg">Hecho.</div>
    </div>
  </div>

<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const toast = (msg)=>{
    const t = $('#toast');
    t.firstElementChild.textContent = msg;
    t.classList.remove('hidden');
    setTimeout(()=> t.classList.add('hidden'), 1800);
  };

  const LS_KEY = 'trello-importer-cred';
  try {
    const saved = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
    if (saved.key) $('#apiKey').value = saved.key;
    if (saved.token) $('#token').value = saved.token;
  } catch {}

  $('#btnSaveLocal').addEventListener('click', ()=>{
    const payload = { key: $('#apiKey').value.trim(), token: $('#token').value.trim() };
    localStorage.setItem(LS_KEY, JSON.stringify(payload));
    toast('Credenciales guardadas en este navegador.');
  });
  $('#btnClearLocal').addEventListener('click', ()=>{
    localStorage.removeItem(LS_KEY);
    toast('Credenciales borradas.');
  });

  const api = {
    key: ()=> $('#apiKey').value.trim(),
    token: ()=> $('#token').value.trim(),
    base: 'https://api.trello.com/1/'
  };

  function log(msg, cls='') {
    const el = $('#log');
    el.textContent += (cls ? '['+cls.toUpperCase()+'] ' : '') + msg + "\n";
    el.scrollTop = el.scrollHeight;
  }
  function setStatus(msg){ $('#status').textContent = msg; }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  async function trelloGET(path, params={}) {
    const url = new URL(api.base + path);
    url.searchParams.set('key', api.key());
    url.searchParams.set('token', api.token());
    Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
    const res = await fetch(url.toString());
    if(!res.ok){
      const t = await res.text();
      throw new Error('GET '+path+' '+res.status+' -> '+t);
    }
    return res.json();
  }
  async function trelloPOST(path, body={}) {
    const url = new URL(api.base + path);
    url.searchParams.set('key', api.key());
    url.searchParams.set('token', api.token());
    const res = await fetch(url.toString(), {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error('POST '+path+' '+res.status+' -> '+t);
    }
    return res.json();
  }

  function parseCSV(text){
    if (text.charCodeAt(0) === 0xFEFF) { text = text.slice(1); }
    const rows=[]; let row=[], cur='', inQ=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i], nx=text[i+1];
      if(ch === '"' && !inQ){ inQ=true; continue; }
      if(ch === '"' && inQ){
        if(nx === '"'){ cur+='"'; i++; continue; }
        inQ=false; continue;
      }
      if(ch === ',' && !inQ){ row.push(cur); cur=''; continue; }
      if((ch === '\n' || ch === '\r') && !inQ){
        if(cur!=='' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; }
        if(ch === '\r' && nx === '\n'){ i++; }
        continue;
      }
      cur += ch;
    }
    if(cur!=='' || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  $('#btnLoadBoards').addEventListener('click', async ()=>{
    try {
      $('#btnLoadBoards').disabled = true;
      setStatus('Cargando tableros…');
      const boards = await trelloGET('members/me/boards', { fields:'name' });
      const openBoards = boards.filter(b=>!b.closed);
      const sel = $('#boardSelect');
      sel.innerHTML = '<option value="">Seleccioná…</option>';
      openBoards.forEach(b=>{
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = b.name;
        sel.appendChild(opt);
      });
      sel.disabled = false;
      $('#btnRun').disabled = false;
      setStatus('Tableros cargados. Seleccioná uno y ejecutá la importación.');
      log('Tableros: '+openBoards.map(b=>b.name).join(', '),'ok');
      toast('Tableros cargados.');
    } catch(e){
      setStatus('Error al cargar tableros.');
      log(e.message,'err');
      $('#btnLoadBoards').disabled = false;
    }
  });

  $('#btnRun').addEventListener('click', async ()=>{
    const file = $('#csvFile').files[0];
    const boardId = $('#boardSelect').value;
    if(!api.key() || !api.token()){ alert('Ingresá API Key y Token.'); return; }
    if(!file){ alert('Seleccioná un CSV.'); return; }
    if(!boardId){ alert('Seleccioná un tablero.'); return; }

    try{
      $('#btnRun').disabled = true;
      setStatus('Leyendo CSV…');
      const text = await file.text();
      const rows = parseCSV(text);
      if(rows.length < 2) throw new Error('CSV vacío o sin filas.');

      const headers = rows[0].map(h=>h.trim());
      const idxName = headers.findIndex(h=>/^name$/i.test(h));
      const idxDesc = headers.findIndex(h=>/^description$/i.test(h));
      const idxLabels = headers.findIndex(h=>/^labels?$/i.test(h));
      const idxList = headers.findIndex(h=>/^list$/i.test(h));
      if([idxName, idxDesc, idxLabels, idxList].some(i=>i<0)){
        throw new Error('El CSV debe tener columnas: Name, Description, Labels, List');
      }
      const items = rows.slice(1).filter(r => (r[idxName]||'').trim() !== '');
      const total = items.length;
      if(!total) throw new Error('No hay filas válidas en el CSV.');

      log('Filas a crear: '+ total, 'ok');
      $('#prog').max = total;
      $('#prog').value = 0;

      setStatus('Cargando listas y etiquetas del tablero…');
      let lists = await trelloGET(`boards/${boardId}/lists`, { fields:'name' });
      let labels = await trelloGET(`boards/${boardId}/labels`, { fields:'name,color', limit: 1000 });

      const delayMs = Math.max(0, parseInt($('#delay').value||'0',10) || 0);

      let created=0, errors=0, skipped=0;
      for(const row of items){
        const name = (row[idxName]||'').trim();
        const desc = (row[idxDesc]||'').trim();
        const listName = (row[idxList]||'Backlog').trim() || 'Backlog';
        const labelsRaw = (row[idxLabels]||'').trim();

        if(!name){ skipped++; continue; }

        try{
          const list = await ensureList(boardId, lists, listName);
          const labelNames = labelsRaw.split(',').map(s=>s.trim()).filter(Boolean);
          const labelIds = [];
          for(const ln of labelNames){
            const lab = await ensureLabel(boardId, labels, ln);
            if(lab) labelIds.push(lab.id);
          }
          await trelloPOST('cards', { name, desc, idList: list.id, idLabels: labelIds.join(',') || undefined });
          created++;
          $('#prog').value = created + skipped + errors;
          setStatus(`Progreso: ${created + skipped + errors} / ${total}`);
          if(delayMs) await sleep(delayMs);
        } catch(e){
          errors++;
          log('Error creando "'+name+'": '+e.message,'err');
        }
      }

      setStatus(`Finalizado. Creadas: ${created}, Omitidas: ${skipped}, Errores: ${errors}`);
      log(`Creadas: ${created}, Omitidas: ${skipped}, Errores: ${errors}`, errors? 'warn' : 'ok');
      toast('Importación finalizada.');
    }catch(e){
      setStatus('Fallo en la importación.');
      log(e.message,'err');
    }finally{
      $('#btnRun').disabled = false;
    }
  });

  async function ensureList(boardId, listsCache, name){
    let l = listsCache.find(x => x.name.toLowerCase() === name.toLowerCase());
    if(l) return l;
    l = await trelloPOST('lists', { idBoard: boardId, name, pos:'bottom' });
    listsCache.push(l);
    await sleep(150);
    return l;
  }
  async function ensureLabel(boardId, labelsCache, name){
    if(!name) return null;
    let lab = labelsCache.find(x => (x.name||'').toLowerCase() === name.toLowerCase());
    if(lab) return lab;
    lab = await trelloPOST('labels', { idBoard: boardId, name, color: null });
    labelsCache.push(lab);
    await sleep(120);
    return lab;
  }
})();
</script>
</body>
</html>