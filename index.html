<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Importar Backlog a Trello — CSV → Tarjetas (Tailwind)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark">
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold tracking-tight">Importar Backlog a Trello</h1>
      <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">CSV → Tarjetas. Compatible con Windows/Mac/Linux (CRLF/LF) y archivos con BOM.</p>
    </header>

    <section class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 mb-6 shadow-sm">
      <p>Este asistente crea <span class="font-medium">listas que falten</span> (p. ej. <code>Backlog</code>) y luego tarjetas a partir de un CSV con columnas <code class="bg-slate-100 dark:bg-slate-700 px-1 rounded">Name, Description, Labels, List</code>.</p>
      <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Los errores de telemetría de Atlassian (<code>xp.atlassian.com</code>) son inocuos. El flujo usa exclusivamente <code>api.trello.com</code>.</p>
    </section>

    <section class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 mb-6 shadow-sm">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="apiKey" class="block text-sm font-medium mb-1">API Key de Trello</label>
          <input id="apiKey" type="text" placeholder="p.ej. 6260..." class="w-full rounded-xl border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" />
        </div>
        <div>
          <label for="token" class="block text-sm font-medium mb-1">Token personal</label>
          <input id="token" type="password" placeholder="Tu token de autorización" class="w-full rounded-xl border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" />
        </div>
        <div>
          <label for="csvFile" class="block text-sm font-medium mb-1">CSV</label>
          <input id="csvFile" type="file" accept=".csv,text/csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200 dark:file:bg-slate-700 dark:file:text-slate-100 dark:hover:file:bg-slate-600" />
          <p class="text-xs text-slate-500 mt-1">Asegurate del encabezado: <code>Name,Description,Labels,List</code>.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="boardSelect" class="block text-sm font-medium mb-1">Tablero destino</label>
            <select id="boardSelect" disabled class="w-full rounded-xl border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
              <option value="">Cargar tableros…</option>
            </select>
          </div>
          <div>
            <label for="delay" class="block text-sm font-medium mb-1">Delay por tarjeta (ms)</label>
            <input id="delay" type="number" value="180" class="w-full rounded-xl border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" />
            <p class="text-xs text-slate-500 mt-1">Subí a 250–300 si ves rate limit.</p>
          </div>
        </div>
      </div>

      <div class="mt-5 flex flex-wrap items-center gap-3">
        <button id="btnLoadBoards" class="inline-flex items-center gap-2 rounded-xl bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold px-4 py-2 shadow-sm transition">
          <span>1) Cargar tableros</span>
        </button>
        <button id="btnRun" disabled class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold px-4 py-2 shadow-sm transition disabled:opacity-50 disabled:cursor-not-allowed">
          <span>2) Importar CSV → Trello</span>
        </button>
        <button id="btnSaveLocal" class="ml-auto text-xs text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">Guardar key/token en este navegador</button>
        <button id="btnClearLocal" class="text-xs text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">Borrar key/token</button>
      </div>
    </section>

    <section class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
      <div class="flex items-center justify-between mb-3">
        <div>
          <label for="prog" class="block text-sm font-medium">Estado</label>
          <div id="status" class="text-sm text-slate-500 dark:text-slate-400">Esperando…</div>
        </div>
        <progress id="prog" value="0" max="100" class="w-64 h-3"></progress>
      </div>
      <div>
        <label for="log" class="block text-sm font-medium mb-1">Registro</label>
        <pre id="log" class="bg-slate-900 text-slate-100 rounded-xl p-3 text-xs max-h-72 overflow-auto"></pre>
      </div>
    </section>

    <div id="toast" class="fixed bottom-4 right-4 hidden">
      <div class="bg-slate-900/90 text-white text-sm px-4 py-2 rounded-xl shadow-lg">Hecho.</div>
    </div>
  </div>

  <!-- Modal de Privacidad + Cómo funciona -->
<div id="privacyModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="privacy-title" role="dialog" aria-modal="true">
  <!-- Backdrop -->
  <div id="privacyBackdrop" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm"></div>

  <!-- Panel -->
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-lg rounded-2xl bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-black/5">
      <div class="p-5">
        <div class="flex items-start gap-3">
          <div class="shrink-0 rounded-xl bg-sky-100 text-sky-700 dark:bg-sky-900/40 dark:text-sky-300 p-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M12 9v3m0 4h.01M12 3c-4.97 0-9 3.582-9 8 0 2.386 1.158 4.52 3 5.953V21l3.09-1.545A10.97 10.97 0 0 0 12 19c4.97 0 9-3.582 9-8s-4.03-8-9-8z"/>
            </svg>
          </div>
          <div class="grow">
            <h2 id="privacy-title" class="text-lg font-semibold">Aviso de privacidad</h2>
            <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">
              ¡Este importador <span class="font-medium">NO envía</span> tu API Key, token ni contraseñas a ningún servidor!
              Todo corre local en tu navegador. Si elegís "Guardar key/token", se guardan solo tu navegador.
            </p>

            <ul class="mt-3 list-disc pl-5 text-sm text-slate-600 dark:text-slate-300 space-y-1">
              <li>Sin backend: no almacena credenciales.</li>
              <li>Las llamadas van directo a <code class="px-1 rounded bg-slate-100 dark:bg-slate-700">api.trello.com</code>.</li>
              <li>Podés borrar las credenciales cuando quieras.</li>
            </ul>

            <label class="mt-4 inline-flex items-center gap-2 text-sm">
              <input id="privacyDontShow" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500 dark:bg-slate-900 dark:border-slate-600">
              No volver a mostrar en este navegador
            </label>

            <!-- Disclosure -->
            <div class="mt-4 border-t border-slate-200 dark:border-slate-700 pt-4">
              <button id="privacyHowBtn"
                      class="inline-flex items-center gap-2 text-sm font-medium text-slate-700 dark:text-slate-200 hover:text-sky-600 focus:outline-none"
                      aria-expanded="false" aria-controls="privacyHowPanel" type="button">
                <svg class="h-4 w-4 transition-transform" id="privacyHowIcon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.25 8.29a.75.75 0 01-.02-1.08z" clip-rule="evenodd"/>
                </svg>
                Ver cómo funciona
              </button>
              <div id="privacyHowPanel" class="mt-3 hidden text-sm text-slate-600 dark:text-slate-300">
                <p class="mb-2">Flujo de ejecución:</p>
                <ol class="list-decimal pl-5 space-y-1">
                  <li>Generar TOKEN en Trello.</li>
                  <li>Cargar CSV con formato: <code>Name,Description,Labels,List</code>.</li>
                  <li>El sistema carga tus tableros.</li>
                  <li>Seleccionar tablero en el cual queres cargar las tarjetas.</li>
                  <li>Por cada fila:
                    <ul class="list-disc pl-5 mt-1">
                      <li>Crea las listas.</li>
                      <li>Crea la etiqueta si no existe.</li>
                      <li>Crea la tarjeta con <code>name</code>, <code>desc</code>, <code>idList</code> y <code>idLabels</code>.</li>
                    </ul>
                  </li>
                  <li>Se muestra el progreso y los logs. Ejemplo:</li>
                </ol>
                <pre class="mt-3 bg-slate-900 text-slate-100 rounded-xl p-3 overflow-auto text-xs">
→ [OK] Tableros: TEST-TRELLO-2025
→ [OK] Filas a crear: 8
→ [OK] Creadas: 8, Omitidas: 0, Errores: 0
                </pre>
              </div>
            </div>
            <!-- /Disclosure -->
          </div>
        </div>

        <div class="mt-5 flex items-center justify-end gap-2">
          <button id="privacyClose"
                  class="inline-flex items-center rounded-xl bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
            Entendido
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const toast = (msg)=>{
    const t = $('#toast');
    t.firstElementChild.textContent = msg;
    t.classList.remove('hidden');
    setTimeout(()=> t.classList.add('hidden'), 1800);
  };

  const LS_KEY = 'trello-importer-cred';
  try {
    const saved = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
    if (saved.key) $('#apiKey').value = saved.key;
    if (saved.token) $('#token').value = saved.token;
  } catch {}

  $('#btnSaveLocal').addEventListener('click', ()=>{
    const payload = { key: $('#apiKey').value.trim(), token: $('#token').value.trim() };
    localStorage.setItem(LS_KEY, JSON.stringify(payload));
    toast('Credenciales guardadas en este navegador.');
  });
  $('#btnClearLocal').addEventListener('click', ()=>{
    localStorage.removeItem(LS_KEY);
    toast('Credenciales borradas.');
  });

  const api = {
    key: ()=> $('#apiKey').value.trim(),
    token: ()=> $('#token').value.trim(),
    base: 'https://api.trello.com/1/'
  };

  function log(msg, cls='') {
    const el = $('#log');
    el.textContent += (cls ? '['+cls.toUpperCase()+'] ' : '') + msg + "\n";
    el.scrollTop = el.scrollHeight;
  }
  function setStatus(msg){ $('#status').textContent = msg; }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  async function trelloGET(path, params={}) {
    const url = new URL(api.base + path);
    url.searchParams.set('key', api.key());
    url.searchParams.set('token', api.token());
    Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
    const res = await fetch(url.toString());
    if(!res.ok){
      const t = await res.text();
      throw new Error('GET '+path+' '+res.status+' -> '+t);
    }
    return res.json();
  }
  async function trelloPOST(path, body={}) {
    const url = new URL(api.base + path);
    url.searchParams.set('key', api.key());
    url.searchParams.set('token', api.token());
    const res = await fetch(url.toString(), {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error('POST '+path+' '+res.status+' -> '+t);
    }
    return res.json();
  }

  function parseCSV(text){
    if (text.charCodeAt(0) === 0xFEFF) { text = text.slice(1); }
    const rows=[]; let row=[], cur='', inQ=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i], nx=text[i+1];
      if(ch === '"' && !inQ){ inQ=true; continue; }
      if(ch === '"' && inQ){
        if(nx === '"'){ cur+='"'; i++; continue; }
        inQ=false; continue;
      }
      if(ch === ',' && !inQ){ row.push(cur); cur=''; continue; }
      if((ch === '\n' || ch === '\r') && !inQ){
        if(cur!=='' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; }
        if(ch === '\r' && nx === '\n'){ i++; }
        continue;
      }
      cur += ch;
    }
    if(cur!=='' || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  $('#btnLoadBoards').addEventListener('click', async ()=>{
    try {
      $('#btnLoadBoards').disabled = true;
      setStatus('Cargando tableros…');
      const boards = await trelloGET('members/me/boards', { fields:'name' });
      const openBoards = boards.filter(b=>!b.closed);
      const sel = $('#boardSelect');
      sel.innerHTML = '<option value="">Seleccioná…</option>';
      openBoards.forEach(b=>{
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = b.name;
        sel.appendChild(opt);
      });
      sel.disabled = false;
      $('#btnRun').disabled = false;
      setStatus('Tableros cargados. Seleccioná uno y ejecutá la importación.');
      log('Tableros: '+openBoards.map(b=>b.name).join(', '),'ok');
      toast('Tableros cargados.');
    } catch(e){
      setStatus('Error al cargar tableros.');
      log(e.message,'err');
      $('#btnLoadBoards').disabled = false;
    }
  });

  $('#btnRun').addEventListener('click', async ()=>{
    const file = $('#csvFile').files[0];
    const boardId = $('#boardSelect').value;
    if(!api.key() || !api.token()){ alert('Ingresá API Key y Token.'); return; }
    if(!file){ alert('Seleccioná un CSV.'); return; }
    if(!boardId){ alert('Seleccioná un tablero.'); return; }

    try{
      $('#btnRun').disabled = true;
      setStatus('Leyendo CSV…');
      const text = await file.text();
      const rows = parseCSV(text);
      if(rows.length < 2) throw new Error('CSV vacío o sin filas.');

      const headers = rows[0].map(h=>h.trim());
      const idxName = headers.findIndex(h=>/^name$/i.test(h));
      const idxDesc = headers.findIndex(h=>/^description$/i.test(h));
      const idxLabels = headers.findIndex(h=>/^labels?$/i.test(h));
      const idxList = headers.findIndex(h=>/^list$/i.test(h));
      if([idxName, idxDesc, idxLabels, idxList].some(i=>i<0)){
        throw new Error('El CSV debe tener columnas: Name, Description, Labels, List');
      }
      const items = rows.slice(1).filter(r => (r[idxName]||'').trim() !== '');
      const total = items.length;
      if(!total) throw new Error('No hay filas válidas en el CSV.');

      log('Filas a crear: '+ total, 'ok');
      $('#prog').max = total;
      $('#prog').value = 0;

      setStatus('Cargando listas y etiquetas del tablero…');
      let lists = await trelloGET(`boards/${boardId}/lists`, { fields:'name' });
      let labels = await trelloGET(`boards/${boardId}/labels`, { fields:'name,color', limit: 1000 });

      const delayMs = Math.max(0, parseInt($('#delay').value||'0',10) || 0);

      let created=0, errors=0, skipped=0;
      for(const row of items){
        const name = (row[idxName]||'').trim();
        const desc = (row[idxDesc]||'').trim();
        const listName = (row[idxList]||'Backlog').trim() || 'Backlog';
        const labelsRaw = (row[idxLabels]||'').trim();

        if(!name){ skipped++; continue; }

        try{
          const list = await ensureList(boardId, lists, listName);
          const labelNames = labelsRaw.split(',').map(s=>s.trim()).filter(Boolean);
          const labelIds = [];
          for(const ln of labelNames){
            const lab = await ensureLabel(boardId, labels, ln);
            if(lab) labelIds.push(lab.id);
          }
          await trelloPOST('cards', { name, desc, idList: list.id, idLabels: labelIds.join(',') || undefined });
          created++;
          $('#prog').value = created + skipped + errors;
          setStatus(`Progreso: ${created + skipped + errors} / ${total}`);
          if(delayMs) await sleep(delayMs);
        } catch(e){
          errors++;
          log('Error creando "'+name+'": '+e.message,'err');
        }
      }

      setStatus(`Finalizado. Creadas: ${created}, Omitidas: ${skipped}, Errores: ${errors}`);
      log(`Creadas: ${created}, Omitidas: ${skipped}, Errores: ${errors}`, errors? 'warn' : 'ok');
      toast('Importación finalizada.');
    }catch(e){
      setStatus('Fallo en la importación.');
      log(e.message,'err');
    }finally{
      $('#btnRun').disabled = false;
    }
  });

  async function ensureList(boardId, listsCache, name){
    let l = listsCache.find(x => x.name.toLowerCase() === name.toLowerCase());
    if(l) return l;
    l = await trelloPOST('lists', { idBoard: boardId, name, pos:'bottom' });
    listsCache.push(l);
    await sleep(150);
    return l;
  }
  async function ensureLabel(boardId, labelsCache, name){
    if(!name) return null;
    let lab = labelsCache.find(x => (x.name||'').toLowerCase() === name.toLowerCase());
    if(lab) return lab;
    lab = await trelloPOST('labels', { idBoard: boardId, name, color: null });
    labelsCache.push(lab);
    await sleep(120);
    return lab;
  }
})();

(function(){
  const MODAL_ID = 'privacyModal';
  const ACK_KEY  = 'trello-importer-privacy-ack';

  const $ = (s)=>document.querySelector(s);
  const modal    = $('#'+MODAL_ID);
  const closeBt  = $('#privacyClose');
  const chk      = $('#privacyDontShow');
  const backdrop = $('#privacyBackdrop');

  // Accordion
  const howBtn   = $('#privacyHowBtn');
  const howIcon  = $('#privacyHowIcon');
  const howPanel = $('#privacyHowPanel');

  function openModal(){
    modal.classList.remove('hidden');
    closeBt?.focus();
    document.addEventListener('keydown', onEsc);
  }
  function closeModal(){
    modal.classList.add('hidden');
    document.removeEventListener('keydown', onEsc);
  }
  function onEsc(e){ if(e.key === 'Escape') closeModal(); }

  // Mostrar al cargar si no fue aceptado
  window.addEventListener('DOMContentLoaded', () => {
    try {
      const ack = localStorage.getItem(ACK_KEY);
      if (ack !== '1') openModal();
    } catch { openModal(); }
  });

  // Cerrar y recordar preferencia
  closeBt?.addEventListener('click', () => {
    try { if (chk?.checked) localStorage.setItem(ACK_KEY, '1'); } catch {}
    closeModal();
  });

  // Click en backdrop cierra
  backdrop?.addEventListener('click', closeModal);

  // Toggle acordeón
  howBtn?.addEventListener('click', () => {
    const expanded = howBtn.getAttribute('aria-expanded') === 'true';
    howBtn.setAttribute('aria-expanded', String(!expanded));
    howPanel.classList.toggle('hidden', expanded);
    // Rotación del ícono
    if (expanded) {
      howIcon.style.transform = 'rotate(0deg)';
    } else {
      howIcon.style.transform = 'rotate(180deg)';
    }
  });
})();
</script>
</body>
</html>